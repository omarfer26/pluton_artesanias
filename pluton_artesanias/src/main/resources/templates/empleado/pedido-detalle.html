<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Detalle del Pedido - Empleado</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
<h2>Pedido #<span th:text="${pedido.id}"></span></h2>

<p><strong>Cliente:</strong> <span th:text="${pedido.clienteNombre}"></span></p>
<p><strong>Estado actual:</strong> <span th:text="${pedido.estado}"></span></p>
<p><strong>Total:</strong> $<span th:text="${pedido.total}"></span></p>
<p><strong>Notas actuales:</strong> <span th:text="${pedido.notas} ?: 'Ninguna'"></span></p>
<p><strong>Fecha de entrega:</strong> 
    <span th:text="${#temporals.format(pedido.fechaEntrega, 'yyyy-MM-dd''T''HH:mm')}"></span>
</p>

<hr>

<h3>Editar Estado, Notas y Fecha de Entrega</h3>

<form th:action="@{'/empleado/dashboard/pedido/' + ${pedido.id} + '/actualizar'}" 
      method="post"
      th:if="${pedido.estado != 'DELIVERED' and pedido.estado != 'CANCELLED'}">

    <label>Estado:</label>
    <select name="estado">
        <option value="CREATED" th:selected="${pedido.estado == 'CREATED'}">CREATED</option>
        <option value="PROCESSING" th:selected="${pedido.estado == 'PROCESSING'}">PROCESSING</option>
        <option value="SHIPPED" th:selected="${pedido.estado == 'SHIPPED'}">SHIPPED</option>
        <option value="DELIVERED" th:selected="${pedido.estado == 'DELIVERED'}">DELIVERED</option>
        <option value="CANCELLED" th:selected="${pedido.estado == 'CANCELLED'}">CANCELLED</option>
    </select>
    <br><br>

    <label>Notas:</label>
    <textarea name="notas" rows="4" cols="50" th:text="${pedido.notas}"></textarea>
    <br><br>

    <label>Fecha de Entrega (opcional):</label>
    <input type="datetime-local" name="fechaEntrega"
       th:value="${pedido.fechaEntrega != null ? #temporals.format(pedido.fechaEntrega, 'yyyy-MM-dd''T''HH:mm') : ''}" />
    <br><br>

    <h3>Productos del Pedido (Modificar Precios)</h3>
    <table border="1">
        <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio Unit.</th>
        </tr>
        <tr th:each="d, iterStat : ${pedido.detalles}">
            <td th:text="${d.producto.nombre}"></td>
            <td th:text="${d.cantidad}"></td>
            <td><input type="text" th:value="${d.subtotal}" name="precio_[[${iterStat.index}]]"></td>
        </tr>
    </table>

    <br>
    <button type="submit">Guardar Cambios</button>
</form>

<div th:if="${pedido.estado == 'DELIVERED' or pedido.estado == 'CANCELLED'}">
    <label>Estado:</label>
    <input type="text" th:value="${pedido.estado}" disabled>
    <br><br>
    <label>Notas:</label>
    <textarea rows="4" cols="50" th:text="${pedido.notas}" disabled></textarea>
    <br><br>
    <label>Fecha de entrega:</label>
    <input type="text" th:value="${pedido.fechaEntrega != null} ? ${#temporals.format(pedido.fechaEntrega,'yyyy-MM-dd HH:mm')} : 'No asignada'" disabled>
    
    <h3>Productos del Pedido</h3>
    <table border="1">
        <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio Unit.</th>
        </tr>
        <tr th:each="d : ${pedido.detalles}">
            <td th:text="${d.producto.nombre}"></td>
            <td th:text="${d.cantidad}"></td>
            <td th:text="${d.subtotal}"></td>
        </tr>
    </table>
</div>

<br>

<div th:if="${pedido.estado != 'DELIVERED' and pedido.estado != 'CANCELLED'}">
    <form th:action="@{'/empleado/pedido/' + ${pedido.id} + '/cancelar'}" method="post">
        <button type="submit" style="background:red;color:white;">Cancelar Pedido</button>
    </form>
</div>

<hr>
<br>
<button onclick="window.history.back()">Regresar</button>

</body>
</html>
